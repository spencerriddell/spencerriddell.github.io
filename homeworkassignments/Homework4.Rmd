---
title: "NY NOAA Weather Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: cosmo
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(plotly)
library(dplyr)
library(tidyr)
library(lubridate)
library(purrr)
library(stringr)
library(p8105.datasets)
library(viridisLite)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# Load packaged dataset (large ~2.6M rows)
data("ny_noaa", package = "p8105.datasets")

# Light cleaning and unit conversions
weather <- ny_noaa %>%
  mutate(
    date    = as.Date(date),
    year    = year(date),
    month   = month(date, label = TRUE, abbr = TRUE),  # ordered factor Jan..Dec
    # Units: tmax/tmin are tenths of °C -> convert to °C; prcp is tenths of mm -> mm
    tmax_c  = as.numeric(tmax) / 10,
    tmin_c  = as.numeric(tmin) / 10,
    prcp_mm = as.numeric(prcp) / 10,
    snow_mm = as.numeric(snow),
    snwd_mm = as.numeric(snwd)
  )

station_choices <- sort(unique(weather$id))
year_range <- range(weather$year, na.rm = TRUE)
top_station <- weather %>% count(id, sort = TRUE) %>% slice(1) %>% pull(id)

# Palettes
palette_month <- viridis(12, option = "D") # for discrete months
palette_lines <- c("Tmax (°C)" = "#e45756", "Tmin (°C)" = "#4c78a8")
```

Sidebar {.sidebar}
-----------------------------------------------------------------------

```{r}
selectizeInput(
  "station", "Weather station (GHCND ID)",
  choices  = station_choices,
  selected = top_station,
  options  = list(placeholder = "Type to search station ID")
)

sliderInput(
  "years", "Year range",
  min = year_range[1], max = year_range[2],
  value = c(max(year_range[1], 1995), min(year_range[2], 2005)),
  sep = ""
)

numericInput(
  "sample_n", "Scatter sample size (points)", value = 10000, min = 1000, max = 100000, step = 1000
)

helpText("Notes: Temperatures in °C; precipitation in mm. Missing values are dropped per-plot.")
```

Row {data-height=450}
-----------------------------------------------------------------------

### Tmax vs Tmin (scatter) — sampled days

```{r}
renderPlotly({
  req(input$station, input$years)
  df <- weather %>%
    filter(id == input$station, between(year, input$years[1], input$years[2])) %>%
    filter(!is.na(tmax_c), !is.na(tmin_c))

  n <- min(nrow(df), input$sample_n)
  if (n > 0) df <- df %>% slice_sample(n = n)

  p <- plot_ly(
    df,
    x = ~tmin_c, y = ~tmax_c,
    type = "scatter", mode = "markers",
    color = ~month, colors = palette_month,
    text = ~paste("Date:", date, "<br>Month:", month),
    hoverinfo = "text",
    marker = list(size = 6, opacity = 0.5, line = list(width = 0))
  ) %>%
    layout(
      xaxis = list(title = "Daily minimum temperature (°C)"),
      yaxis = list(title = "Daily maximum temperature (°C)")
    )

  # Add y = x reference line
  rng <- range(c(df$tmin_c, df$tmax_c), na.rm = TRUE)
  p %>% layout(shapes = list(list(
    type = "line", x0 = rng[1], y0 = rng[1], x1 = rng[2], y1 = rng[2],
    line = list(color = "gray", dash = "dash")
  )))
})
```

### Monthly mean temperatures (line)

```{r}
renderPlotly({
  req(input$station, input$years)
  df <- weather %>%
    filter(id == input$station, between(year, input$years[1], input$years[2])) %>%
    group_by(year, month) %>%
    summarize(
      tmax_c = mean(tmax_c, na.rm = TRUE),
      tmin_c = mean(tmin_c, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    pivot_longer(c(tmax_c, tmin_c), names_to = "var", values_to = "value") %>%
    mutate(
      var = recode(var, tmax_c = "Tmax (°C)", tmin_c = "Tmin (°C)"),
      var = factor(var, levels = names(palette_lines)),
      ym = as.Date(paste(year, as.integer(month), "01", sep = "-"))
    )

  plot_ly(df, x = ~ym, y = ~value, color = ~var, colors = palette_lines,
          type = "scatter", mode = "lines+markers",
          hovertemplate = paste(
            "Month: %{x|%b %Y}<br>",
            "%{trace.name}: %{y:.1f}°C<extra></extra>"
          )) %>%
    layout(
      xaxis = list(title = "Month"),
      yaxis = list(title = "Mean temperature (°C)")
    )
})
```

Row {data-height=480}
-----------------------------------------------------------------------

### Temperature by month (boxplot)

```{r}
renderPlotly({
  req(input$station, input$years)
  df <- weather %>%
    filter(id == input$station, between(year, input$years[1], input$years[2])) %>%
    filter(!is.na(tmax_c))

  plot_ly(df, x = ~month, y = ~tmax_c, type = "box",
          boxpoints = "outliers", jitter = 0, pointpos = 0,
          marker = list(opacity = 0.4),
          hovertemplate = "Month: %{x}<br>Tmax: %{y:.1f}°C<extra></extra>") %>%
    layout(
      xaxis = list(title = "Month"),
      yaxis = list(title = "Daily max temperature (°C)")
    )
})
```

### Monthly precipitation (bar)

```{r}
renderPlotly({
  req(input$station, input$years)
  df <- weather %>%
    filter(id == input$station, between(year, input$years[1], input$years[2])) %>%
    group_by(year, month) %>%
    summarize(
      total_prcp_mm = sum(prcp_mm, na.rm = TRUE),
      wet_days = sum(prcp_mm > 0, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(ym = as.Date(paste(year, as.integer(month), "01", sep = "-")))

  # Bars: total precipitation; line: wet day count (secondary axis simulated via scale)
  prcp_max <- max(df$total_prcp_mm, na.rm = TRUE)
  wet_max  <- max(df$wet_days, na.rm = TRUE)
  scale    <- ifelse(wet_max > 0, prcp_max / wet_max, 1)

  plot_ly(df, x = ~ym, y = ~total_prcp_mm, type = "bar",
          name = "Total precipitation (mm)", marker = list(color = "#59a14f"),
          hovertemplate = "Month: %{x|%b %Y}<br>Total prcp: %{y:.0f} mm<extra></extra>") %>%
    add_trace(y = ~wet_days * scale, type = "scatter", mode = "lines+markers",
              name = "Wet days (count, scaled)", yaxis = "y2",
              line = list(color = "#f28e2b"),
              hovertemplate = "Month: %{x|%b %Y}<br>Wet days: %{text}<extra></extra>",
              text = ~wet_days) %>%
    layout(
      barmode = "overlay",
      xaxis = list(title = "Month"),
      yaxis = list(title = "Total precipitation (mm)"),
      yaxis2 = list(overlaying = "y", side = "right", showgrid = FALSE,
                    title = "Wet days (count, scaled)"),
      legend = list(orientation = "h")
    )
})
```